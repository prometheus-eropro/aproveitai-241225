<!DOCTYPE html>
<html lang="pt-BR">
<head>

<meta charset="UTF-8">
<title>√Årea do Parceiro ‚Ä¢ Cart√£o AproveitAI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:system-ui,Arial,sans-serif;background:linear-gradient(135deg,#bdeeff,#81d4fa);color:#232630}
.brandline{display:grid;grid-template-columns:140px 1fr 140px;gap:12px;align-items:center;justify-items:center;margin:18px auto 0;max-width:600px}
.brandline img{height:100px;object-fit:contain}
.pill{background:#e9fff1;border:1px solid #b7efc2;color:#0a4c1a;border-radius:999px;padding:12px 20px;font-weight:900;font-size:1.6rem;text-align:center}
.wrap{max-width:600px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;box-shadow:0 6px 22px #0001;padding:20px;margin:18px auto}
input{width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #ccc}
button{margin-top:16px;padding:12px 18px;font-weight:800;color:#fff;border:none;border-radius:10px;cursor:pointer;width:100%}
.verde{background:#0a7f2e}
.vermelho{background:#d10000}
#resultado{margin-top:14px;border-radius:12px;padding:14px;border:1px solid #e5eaee;background:#f7fbff}
#resultado.ativo{background:#e9fbe9;border:2px solid #1e8e3e}
#resultado.inativo{background:#fdeaea;border:2px solid #d93025}
.voltar{display:inline-block;margin-top:14px;padding:10px 14px;background:#0a7f2e;color:#fff;border-radius:10px;text-decoration:none;font-weight:800}
.small{font-size:.9rem;color:#444;margin-top:6px}
.btn-relatorio {
  background-color: #0d6efd; /* azul */
  color: #fff;
  border: none;
  padding: 12px;
  width: 100%;
  font-size: 15px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 10px;
}

.btn-relatorio:hover {
  background-color: #084298;
}

.btn-imprimir {
  background-color: #198754; /* verde */
  color: #fff;
  border: none;
  padding: 12px;
  width: 100%;
  font-size: 15px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 10px;
}

.btn-imprimir:hover {
  background-color: #146c43;
}
.vermelho:hover {
  background:#bb2d3b;
  transition:background 0.2s ease;
}

</style>
<link rel="stylesheet" href="style.css">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0a7f2e">

</head>

<body>
<div class="brandline">
  <img src="logo-prometheus.png">
  <div class="pill">Cart√£o AproveitAI</div>
  <img src="logo-aproveitai.png">
</div>

<div class="wrap">

  <!-- LOGIN -->
  <div class="card" id="loginBox">
    <h2 style="margin:0;color:#0a4c1a;text-align:center">Acesso do Parceiro</h2>
    <div class="small"><b>Parceiro</b> use seu CNPJ e token cadastrado.</div>

    <label>CNPJ</label>
    <input id="cnpj" placeholder="Digite seu CNPJ">
    <label>Token</label>
    <input id="token" type="password" placeholder="Digite seu token">

    <button class="verde" onclick="login()">Entrar</button>
    <div id="erroLogin" style="color:#d10000;font-weight:800;margin-top:10px;text-align:center"></div>
    <div style="text-align:center"><a class="voltar" href="index.html">‚Üê Voltar ao site</a></div>
  </div>

  <!-- PAINEL -->
  <div class="card" id="painelBox" style="display:none">
    <h2 style="margin:0;color:#0a4c1a;text-align:center">Bem-vindo, <span id="nomeParceiro"></span></h2>
    <label>CPF ou ID P√∫blico do Cliente</label>
    <input id="chaveCliente" placeholder="Digite o CPF (11 d√≠gitos) ou APV-XXXXX">
    <button class="verde" onclick="validar()">Validar Cliente</button>
<div id="boxResultado" style="
  display:none;
  margin-top:25px;
  padding:18px;
  border-radius:12px;
  border:2px solid #198754;
  background:#f6fff8;
  font-size:15px;
  line-height:1.6;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
"></div>


<button class="btn-relatorio" onclick="abrirRelatorio()">
üìä Ver relat√≥rio de consultas
</button>
<!-- BOT√ÉO SAIR / VOLTAR -->
<div style="margin-top:15px;text-align:center;">
  <button onclick="logout()" class="vermelho" style="
    background:#dc3545;
    color:#fff;
    border:none;
    padding:12px 20px;
    font-weight:700;
    border-radius:8px;
    width:100%;
    cursor:pointer;
  ">
    ‚¨ÖÔ∏è Sair / Voltar
  </button>
</div>

<script>
// ==================== CONFIGURA√á√ÉO GERAL ====================
const API_URL = "https://script.google.com/macros/s/AKfycbzhwXhtWdsDSuABRneoz6QAD1SxpnMq3vc8e1FhtknlB7_1j6qLjYIbPA0qPJS7ck7y/exec";

// ==================== LOGIN ====================
async function login() {
  const cnpj = document.getElementById("cnpj").value.trim();
  const token = document.getElementById("token").value.trim();
  const erro = document.getElementById("erroLogin");
  erro.innerText = "";

  if (!cnpj || !token) {
    erro.innerText = "Informe CNPJ e token.";
    return;
  }

  try {
    const r = await fetch(API_URL + "?aba=parceiros");
    const parceiros = await r.json();

    const parceiro = parceiros.find(p =>
      String(p.cnpj).replace(/\D/g, "") === cnpj.replace(/\D/g, "") &&
      String(p.token).trim() === token &&
      String(p.ativo).toUpperCase() === "SIM"
    );

    if (!parceiro) {
      erro.innerText = "CNPJ ou token inv√°lido.";
      return;
    }

    localStorage.setItem("parceiro_sess", JSON.stringify({
      nome: parceiro.nomeFantasia || parceiro.parceiro
    }));

    document.getElementById("nomeParceiro").innerText =
      parceiro.nomeFantasia || parceiro.parceiro;

    document.getElementById("loginBox").style.display = "none";
    document.getElementById("painelBox").style.display = "block";
  } catch (err) {
    erro.innerText = "Erro ao conectar ao servidor.";
    console.error(err);
  }
}

// ==================== VALIDAR CLIENTE ====================

async function validar() {
  const campoChave = document.getElementById("chaveCliente");
  const chave = campoChave.value.trim();
  const box = document.getElementById("boxResultado");

  if (!chave) {
    alert("Digite o CPF ou ID P√∫blico (ex: APV-XXXX).");
    return;
  }

  box.innerHTML = "‚åõ Consultando cliente...";
  box.style.display = "block";

  try {
    const response = await fetch(API_URL + "?aba=clientes");
    const clientes = await response.json();

    // üîç Busca por CPF ou ID p√∫blico (idPublico)
    const cliente = clientes.find(c =>
      String(c.cpf || "").replace(/\D/g, "") === chave.replace(/\D/g, "") ||
      String(c.idPublico || "").trim().toUpperCase() === chave.trim().toUpperCase()
    );

    // ======= CLIENTE N√ÉO ENCONTRADO =======
    if (!cliente) {
      box.style.background = "#f8f9fa";
      box.style.borderColor = "#6c757d";
      box.innerHTML = `
        <span style="font-size:1.6em;color:#6c757d;">‚ö†Ô∏è</span><br>
        <b style="color:#6c757d;">Cliente n√£o encontrado.</b><br>
        <small>Registro ausente na base de dados.</small>
      `;

      // Salva log sem c√≥digo ERO
      const sess = JSON.parse(localStorage.getItem("parceiro_sess"));
      const parceiroNome = (sess?.nome || "total").trim();

      await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          acao: "salvar_log",
          cpf: chave,
          cliente: "N√ÉO ENCONTRADO",
          parceiro: parceiroNome,
          grupo: "-",
          codigo_ero: "-",
          status: "NAO ENCONTRADO"
        }).toString()
      });

      console.log("üìù Log salvo (n√£o encontrado)");
      return;
    }

    const statusCliente = cliente.ativo?.toString().trim().toUpperCase() === "SIM" ? "ATIVO" : "INATIVO";

    // ========== CLIENTE ATIVO ==========
    if (statusCliente === "ATIVO") {
      // Gera c√≥digo ERO
      const agora = new Date();
      const dia = String(agora.getDate()).padStart(2, "0");
      const mes = String(agora.getMonth() + 1).padStart(2, "0");
      const hora = String(agora.getHours()).padStart(2, "0");
      const minuto = String(agora.getMinutes()).padStart(2, "0");
      const codigoAutorizacao = `ERO-${dia}${mes}-${hora}${minuto}`;

      box.style.background = "#e8fbe8";
      box.style.borderColor = "#28a745";
      box.innerHTML = `
        <div style="font-size:2em;color:#198754;">‚úÖ</div>
        <b>Nome:</b> ${cliente.nome}<br>
        <b>Status:</b> <span style="color:green;font-weight:bold;">${statusCliente}</span><br>
        <b>CPF:</b> ${cliente.cpfMascarado || cliente.cpf.replace(/(\d{3})\d{5}(\d{2})/, "$1*****$2")}<br>
        <b>N¬∫ do Cart√£o:</b> ${cliente.idPublico || "-"}<br>
        <b>Data de Cadastro:</b> ${cliente.dataCadastro || "-"}<br>
        <b>Grupo:</b> ${cliente.grupo || "-"}<br>
        <b style="color:green;">‚úî C√≥digo de Autoriza√ß√£o:</b> <b>${codigoAutorizacao}</b>
      `;

      // Salva log
      const sess = JSON.parse(localStorage.getItem("parceiro_sess"));
      const parceiroNome = (sess?.nome || "total").trim();

      await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          acao: "salvar_log",
          cpf: cliente.cpf || "",
          cliente: cliente.nome || "",
          parceiro: parceiroNome,
          grupo: cliente.grupo || "",
          codigo_ero: codigoAutorizacao,
          status: statusCliente
        }).toString()
      });

      console.log("‚úÖ Log salvo (ATIVO):", codigoAutorizacao);
    }

// ========== CLIENTE INATIVO ==========
else {
  box.style.background = "#fdeaea";
  box.style.borderColor = "#d93025";
  box.innerHTML = `
    <div style="font-size:2em;color:#d93025;">‚õî</div>
    <b>Nome:</b> ${cliente.nome}<br>
    <b>Status:</b> <span style="color:red;font-weight:bold;">${statusCliente}</span><br>
    <b>CPF:</b> ${cliente.cpf}<br>
    <b>N¬∫ do Cart√£o:</b> ${cliente.idPublico || "-"}<br>
    <b>Data de Cadastro:</b> ${cliente.dataCadastro || "-"}<br>
    <b>Grupo:</b> ${cliente.grupo || "-"}<br>
    <b style="color:red;">‚õî Cliente inativo ‚Äì autoriza√ß√£o bloqueada.</b>
  `;

  const sess = JSON.parse(localStorage.getItem("parceiro_sess"));
  const parceiroNome = (sess?.nome || "total").trim();

await fetch(API_URL, {
  method: "POST",
  headers: { "Content-Type": "application/x-www-form-urlencoded" },
  body: new URLSearchParams({
    acao: "salvar_log",
    cpf: cliente.cpf || "",
    cliente: cliente.nome || "",
    parceiro: parceiroNome,
    grupo: cliente.grupo || "",
    codigo_ero: "-",      // ‚úîÔ∏è CORRETO
    status: "INATIVO"     // ‚úîÔ∏è CORRETO
  }).toString()
});
    } // ‚Üê FECHA if (statusCliente === "ATIVO")
  } catch (err) {
    console.error("Erro na valida√ß√£o:", err);
    box.style.background = "#f8d7da";
    box.style.borderColor = "#842029";
    box.innerHTML = "‚ùå Erro ao validar cliente.";
  }
} // ‚Üê FECHA function validar()


// ==================== UTILIT√ÅRIOS ====================
function mascararCPF(cpf) {
  return cpf ? cpf.replace(/^(\d{3})\d{3}\d{3}(\d{2})$/, "$1***.***-$2") : "-";
}

// C√≥digo ERO antifraude (√∫nico)
function gerarCodigoERO() {
  const d = new Date();
  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const hh = String(d.getHours()).padStart(2, "0");
  const min = String(d.getMinutes()).padStart(2, "0");
  return `ERO-${dd}${mm}-${hh}${min}`;
}

// ==================== RELAT√ìRIO ====================
function abrirRelatorio() {
  const sess = JSON.parse(localStorage.getItem("parceiro_sess"));
  if (!sess || !sess.nome) {
    alert("Sess√£o do parceiro inv√°lida.");
    return;
  }

  const url = API_URL + "?relatorio=1&parceiro=" + encodeURIComponent(sess.nome);
  window.open(url, "_blank");
}

// ==================== SAIR ====================
function logout() {
  localStorage.clear();
  location.reload();
}
</script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js");
}
</script>

</body>
</html>
