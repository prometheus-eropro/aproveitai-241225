<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Årea do Parceiro ‚Ä¢ Cart√£o AproveitAI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:system-ui,Arial,sans-serif;background:linear-gradient(135deg,#bdeeff,#81d4fa);color:#232630}
.brandline{display:grid;grid-template-columns:140px 1fr 140px;gap:12px;align-items:center;justify-items:center;margin:18px auto 0;max-width:600px}
.brandline img{height:100px;object-fit:contain}
.pill{background:#e9fff1;border:1px solid #b7efc2;color:#0a4c1a;border-radius:999px;padding:12px 20px;font-weight:900;font-size:1.6rem;text-align:center}
.wrap{max-width:600px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;box-shadow:0 6px 22px #0001;padding:20px;margin:18px auto}
input{width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #ccc}
button{margin-top:16px;padding:12px 18px;font-weight:800;color:#fff;border:none;border-radius:10px;cursor:pointer;width:100%}
.verde{background:#0a7f2e}
.vermelho{background:#d10000}
#resultado{margin-top:14px;border-radius:12px;padding:14px;border:1px solid #e5eaee;background:#f7fbff}
#resultado.ativo{background:#e9fbe9;border:2px solid #1e8e3e}
#resultado.inativo{background:#fdeaea;border:2px solid #d93025}
.voltar{display:inline-block;margin-top:14px;padding:10px 14px;background:#0a7f2e;color:#fff;border-radius:10px;text-decoration:none;font-weight:800}
.small{font-size:.9rem;color:#444;margin-top:6px}
</style>
</head>

<body>

<div class="brandline">
  <img src="logo-prometheus.png">
  <div class="pill">Cart√£o AproveitAI</div>
  <img src="logo-aproveitai.png">
</div>

<div class="wrap">

  <div class="card" id="loginBox">
    <h2 style="margin:0;color:#0a4c1a;text-align:center">Acesso do Parceiro</h2>
    <div class="small"><b>Parceiro</b> use seu CNPJ e token cadastrado .</div>

    <label style="font-weight:800;margin-top:10px;display:block">CNPJ</label>
    <input id="cnpj" placeholder="Digite seu CNPJ">

    <label style="font-weight:800;margin-top:10px;display:block">Token</label>
    <input id="token" type="password" placeholder="Digite seu token">

    <button class="verde" onclick="login()">Entrar</button>
    <div id="erroLogin" style="color:#d10000;font-weight:800;margin-top:10px"></div>

    <div style="text-align:center"><a class="voltar" href="index.html">‚Üê Voltar ao site</a></div>
  </div>

  <div class="card" id="painelBox" style="display:none">
    <h2 style="margin:0;color:#0a4c1a;text-align:center">Bem-vindo, <span id="nomeParceiro"></span></h2>

    <label style="font-weight:800;margin-top:14px;display:block">CPF ou ID P√∫blico do Cliente</label>
    <input id="chaveCliente" placeholder="CPF (11 d√≠gitos) ou APV-XXXX">

    <button class="verde" onclick="validar()">Validar Cliente</button>

    <div id="resultado"></div>
<button class="verde" onclick="carregarRelatorio()">üìä Ver relat√≥rio de consultas</button>
<!-- RELAT√ìRIO DE CONSULTAS -->
<div id="relatorioBox" style="display:none; margin-top:20px;">
  <h3>Consultas dos √∫ltimos 7 dias</h3>

  <table border="1" width="100%" cellpadding="8">
    <thead>
      <tr>
        <th>Data/Hora</th>
        <th>Cliente</th>
        <th>CPF</th>
        <th>Parceiro</th>
        <th>C√≥digo</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="relatorioTabela"></tbody>
  </table>

  <br>
  <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
</div>

    <button class="vermelho" onclick="logout()">Sair</button>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz3qpd3Bc0lDRPBc3L9bJhSB802ajtJt3KxAZNLuy49w5ajB3QTituDHirD5RwWyHJu/exec";

async function login() {
  const cnpj = document.getElementById("cnpj").value.trim();
  const token = document.getElementById("token").value.trim();
  const erro = document.getElementById("erroLogin");

  erro.innerText = "";

  if (!cnpj || !token) {
    erro.innerText = "Informe CNPJ e token.";
    return;
  }

  try {
    const resp = await fetch(API_URL + "?aba=parceiros");
    const parceiros = await resp.json();

    const parceiro = parceiros.find(
      p => String(p.cnpj) === cnpj && String(p.token) === token
    );

    if (!parceiro) {
      erro.innerText = "CNPJ ou token inv√°lido.";
      return;
    }

    // SALVA SESS√ÉO
    localStorage.setItem(
      "parceiro_sess",
      JSON.stringify({
        nome: parceiro.nome || parceiro.parceiro || "Parceiro",
        cnpj: cnpj
      })
    );

    document.getElementById("nomeParceiro").innerText =
      parceiro.nome || parceiro.parceiro || "Parceiro";

    document.getElementById("loginBox").style.display = "none";
    document.getElementById("painelBox").style.display = "block";

  } catch (e) {
    console.error(e);
    erro.innerText = "Erro ao conectar ao servidor.";
  }
}
async function validar() {
  const chave = document.getElementById("chaveCliente").value.trim();
  const resultado = document.getElementById("resultado");
  resultado.innerHTML = "";

  if (!chave) {
    resultado.innerHTML = "Informe o CPF ou ID do cliente.";
    return;
  }

  const sess = JSON.parse(localStorage.getItem("parceiro_sess") || "null");
  if (!sess || !sess.nome) {
    resultado.innerHTML = "Sess√£o do parceiro inv√°lida. Fa√ßa login novamente.";
    return;
  }

  try {
    const resp = await fetch(API_URL + "?aba=clientes");
    const clientes = await resp.json();

    const cliente = clientes.find(c =>
      String(c.cpf) === chave || String(c.codigo) === chave
    );

    let status = "INATIVO";
    let nomeCliente = "-";
    let cpfMascarado = "-";
    let codigo = "-";

    if (cliente && String(cliente.ativo).toUpperCase() === "SIM") {
      status = "ATIVO";
      nomeCliente = cliente.nome || "-";
      cpfMascarado = cliente.cpf
        ? cliente.cpf.replace(/^(\d{3})\d{3}(\d{2})(\d{2})$/, "$1.***.$2-$3")
        : "-";
      codigo = "ERO-" + new Date().toLocaleString("pt-BR").replace(/\D/g,"").slice(0,12);
    }

    resultado.className = status === "ATIVO" ? "ativo" : "inativo";
    resultado.innerHTML = `
      <b>Nome:</b> ${nomeCliente}<br>
      <b>Status:</b> ${status}<br>
      <b>CPF:</b> ${cpfMascarado}<br>
      ${status === "ATIVO" ? `<b>C√≥digo:</b> ${codigo}` : "‚ùå Desconto n√£o autorizado"}
    `;

    // ===== SALVA LOG =====
    await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        aba: "logs",
        dados: {
          dataHora: new Date().toLocaleString("pt-BR"),
          cpfConsultado: cpfMascarado,
          nomeConsultado: nomeCliente,
          parceiro: sess.nome,
          codigoUnicoERC: codigo,
          statusCliente: status
        }
      })
    });

  } catch (e) {
    console.error(e);
    resultado.innerHTML = "Erro ao validar cliente.";
  }
}

// ====== RELAT√ìRIO DE CONSULTAS ======
async function carregarRelatorio() {
  const sess = JSON.parse(localStorage.getItem("parceiro_sess") || "null");
  if (!sess || !sess.nome) {
    alert("Parceiro n√£o identificado. Fa√ßa login novamente.");
    return;
  }

  const box = document.getElementById("relatorioBox");
  const tabela = document.getElementById("relatorioTabela");
  tabela.innerHTML = "";

  try {
    const resp = await fetch(
      API_URL + "?aba=logs&parceiro=" + encodeURIComponent(sess.nome)
    );
    const dados = await resp.json();

    if (!dados || dados.length === 0) {
      tabela.innerHTML =
        "<tr><td colspan='6'>Nenhuma consulta encontrada.</td></tr>";
    } else {
      dados.forEach(l => {
        tabela.innerHTML += `
          <tr>
            <td>${l.dataHora || "-"}</td>
            <td>${l.nomeConsultado || "-"}</td>
            <td>${l.cpfConsultado || "-"}</td>
            <td>${l.parceiro || "-"}</td>
            <td>${l.codigoUnicoERC || "-"}</td>
            <td>${l.statusCliente || "-"}</td>
          </tr>`;
      });
    }

    box.style.display = "block";

  } catch (e) {
    console.error("Erro ao carregar relat√≥rio:", e);
    alert("Erro ao carregar relat√≥rio.");
  }
}
</script>

</body>
</html>
