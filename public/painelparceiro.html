<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Årea do Parceiro ‚Ä¢ Cart√£o AproveitAI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:system-ui,Arial,sans-serif;background:linear-gradient(135deg,#bdeeff,#81d4fa);color:#232630}
.brandline{display:grid;grid-template-columns:140px 1fr 140px;gap:12px;align-items:center;justify-items:center;margin:18px auto 0;max-width:600px}
.brandline img{height:100px;object-fit:contain}
.pill{background:#e9fff1;border:1px solid #b7efc2;color:#0a4c1a;border-radius:999px;padding:12px 20px;font-weight:900;font-size:1.6rem;text-align:center}
.wrap{max-width:600px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;box-shadow:0 6px 22px #0001;padding:20px;margin:18px auto}
input{width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #ccc}
button{margin-top:16px;padding:12px 18px;font-weight:800;color:#fff;border:none;border-radius:10px;cursor:pointer;width:100%}
.verde{background:#0a7f2e}
.vermelho{background:#d10000}
#resultado{margin-top:14px;border-radius:12px;padding:14px;border:1px solid #e5eaee;background:#f7fbff}
#resultado.ativo{background:#e9fbe9;border:2px solid #1e8e3e}
#resultado.inativo{background:#fdeaea;border:2px solid #d93025}
.voltar{display:inline-block;margin-top:14px;padding:10px 14px;background:#0a7f2e;color:#fff;border-radius:10px;text-decoration:none;font-weight:800}
.small{font-size:.9rem;color:#444;margin-top:6px}
</style>
</head>

<body>

<div class="brandline">
  <img src="logo-prometheus.png">
  <div class="pill">Cart√£o AproveitAI</div>
  <img src="logo-aproveitai.png">
</div>

<div class="wrap">

  <div class="card" id="loginBox">
    <h2 style="margin:0;color:#0a4c1a;text-align:center">Acesso do Parceiro</h2>
    <div class="small"><b>Parceiro</b> use seu CNPJ e token cadastrado .</div>

    <label style="font-weight:800;margin-top:10px;display:block">CNPJ</label>
    <input id="cnpj" placeholder="Digite seu CNPJ">

    <label style="font-weight:800;margin-top:10px;display:block">Token</label>
    <input id="token" type="password" placeholder="Digite seu token">

    <button class="verde" onclick="login()">Entrar</button>
    <div id="erroLogin" style="color:#d10000;font-weight:800;margin-top:10px"></div>

    <div style="text-align:center"><a class="voltar" href="index.html">‚Üê Voltar ao site</a></div>
  </div>

  <div class="card" id="painelBox" style="display:none">
    <h2 style="margin:0;color:#0a4c1a;text-align:center">Bem-vindo, <span id="nomeParceiro"></span></h2>

    <label style="font-weight:800;margin-top:14px;display:block">CPF ou ID P√∫blico do Cliente</label>
    <input id="chaveCliente" placeholder="CPF (11 d√≠gitos) ou APV-XXXX">

    <button class="verde" onclick="validar()">Validar Cliente</button>

    <div id="resultado"></div>

    <button class="vermelho" onclick="logout()">Sair</button>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz3qpd3Bc0lDRPBc3L9bJhSB802ajtJt3KxAZNLuy49w5ajB3QTituDHirD5RwWyHJu/exec";

function norm(v){ return String(v ?? "").toLowerCase().trim(); }
function onlyDigits(v){ return String(v ?? "").replace(/\D/g,""); }
function isAtivo(v){ const s = norm(v); return ["sim","true","1","ativo","yes"].includes(s); }

function abrirPainel(p){
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("painelBox").style.display = "block";
  document.getElementById("nomeParceiro").textContent = p.nome || "Parceiro";
}

const sess = JSON.parse(localStorage.getItem("parceiro_sess") || "null");
if(sess) abrirPainel(sess);

async function login(){
  const cnpj = onlyDigits(document.getElementById("cnpj").value);
  const token = document.getElementById("token").value.trim();
  const erro = document.getElementById("erroLogin");
  erro.textContent = "";

  if(!cnpj || !token){ erro.textContent = "Preencha CNPJ e token."; return; }

  try{
    const res = await fetch(`${API_URL}?aba=parceiros`);
    const data = await res.json();
    const achado = data.find(p => onlyDigits(p.cnpj)==cnpj && String(p.token).trim()==token);
    if(!achado){ erro.textContent = "CNPJ ou token inv√°lidos."; return; }
    if(!isAtivo(achado.ativo)){ erro.textContent="Parceiro INATIVO."; return; }

    const nome = achado.nomeFantasia || achado.nome || "Parceiro";
    localStorage.setItem("parceiro_sess", JSON.stringify({ cnpj, nome }));
    abrirPainel({ nome });
  }catch(e){ erro.textContent="Erro ao validar parceiro."; console.error(e); }
}

async function validar(){
  const v = document.getElementById("chaveCliente").value.trim();
  const box = document.getElementById("resultado");
  box.classList.remove("ativo","inativo");
  box.textContent = "Consultando...";

  if(!v){ box.textContent="Informe CPF ou ID P√∫blico."; return; }

  const dig = onlyDigits(v);
  const isCpf = dig.length===11;

  try{
    const url = isCpf ? `${API_URL}?aba=clientes&cpf=${dig}` : `${API_URL}?aba=clientes&idPublico=${v}`;
    const res = await fetch(url);
    const data = await res.json();
    const c = Array.isArray(data) ? (isCpf ? data.find(x=>onlyDigits(x.cpf)===dig) : data.find(x=>String(x.idPublico).trim()===v)) : data;

    const parceiroSess = JSON.parse(localStorage.getItem("parceiro_sess") || "{}");
    const parceiroNome = parceiroSess.nome || "Desconhecido";

    const agora = new Date();
    const dataHora = agora.toLocaleString("pt-BR");
    const dd = String(agora.getDate()).padStart(2,"0");
    const mm = String(agora.getMonth()+1).padStart(2,"0");
    const hh = String(agora.getHours()).padStart(2,"0");
    const min = String(agora.getMinutes()).padStart(2,"0");
    const ss = String(agora.getSeconds()).padStart(2,"0");
    const codigoUnicoERC = `ERO-${dd}${mm}-${hh}${min}${ss}`;

    const cpfOriginal = c?.cpf || v;
    const cpfCamuflado = cpfOriginal.replace(/^(\d{3})\d{3}(\d{3})(\d{2})$/,"$1.***.$2-$3");
    const ativo = c && isAtivo(c.ativo);

    // === Exibir resultado ===
    if(!c || !c.cpf){
      box.innerHTML = `<div><b>Cliente n√£o encontrado.</b></div><div class="small">‚ùå Desconto n√£o autorizado</div>`;
      await registrarLog({
        dataHora, cpfConsultado:cpfCamuflado, nomeConsultado:"-", 
        parceiro:parceiroNome, codigoUnicoERC, statusCliente:"ERRO", beneficiosVigentes:"-"
      });
      return;
    }

    box.classList.add(ativo?"ativo":"inativo");
    box.innerHTML = ativo ? `
      <div><b>Nome:</b> ${c.nome||"-"}</div>
      <div><b>Status:</b> ATIVO</div>
      <div><b>CPF:</b> ${cpfCamuflado}</div>
      <div><b>N√∫mero do Cart√£o:</b> ${c.idPublico||"-"}</div>
      <div><b>C√≥digo de Autoriza√ß√£o:</b> <b>${codigoUnicoERC}</b></div>
      <div class="small">‚úÖ Desconto autorizado</div>`
      :
      `<div><b>Nome:</b> ${c.nome||"-"}</div>
      <div><b>Status:</b> INATIVO</div>
      <div><b>CPF:</b> ${cpfCamuflado}</div>
      <div class="small">‚ùå Desconto n√£o autorizado</div>`;

    // === Registrar log, mesmo ativo ou inativo ===
    await registrarLog({
      dataHora, cpfConsultado:cpfCamuflado, nomeConsultado:c.nome||"-",
      parceiro:parceiroNome, codigoUnicoERC, 
      statusCliente: ativo ? "ATIVO" : "INATIVO",
      beneficiosVigentes: "-"
    });

    carregarRelatorio();

  }catch(e){
    console.error(e);
    box.textContent="Erro na valida√ß√£o.";
    await registrarLog({
      dataHora:new Date().toLocaleString("pt-BR"),
      cpfConsultado:v,
      nomeConsultado:"-",
      parceiro:"Erro no sistema",
      codigoUnicoERC:"ERO-ERRO",
      statusCliente:"ERRO",
      beneficiosVigentes:"-"
    });
  }
}

// === Fun√ß√£o global para salvar log ===
async function registrarLog(dados){
  try{
    const resp = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ aba: "logs", modo: "registrar", dados })
    });
    const result = await resp.json();
    console.log("üìò Log enviado:", result);
  }catch(err){
    console.error("‚ùå Erro ao salvar log:", err);
  }
}

function logout(){
  localStorage.removeItem("parceiro_sess");
  location.reload();
}

async function carregarRelatorio(){
  try{
    const resp = await fetch(`${API_URL}?aba=logs&modo=listar`);
    const dados = await resp.json();
    const seteDiasAtras = new Date();
    seteDiasAtras.setDate(seteDiasAtras.getDate()-7);

    const recentes = dados.filter(l => new Date(l.dataHora) >= seteDiasAtras);
    let html = recentes.map(l => `
      <p>
        <b>${l.dataHora}</b><br>
        ${l.parceiro} ‚Äî <b>${l.nomeConsultado}</b> (${l.cpfConsultado})<br>
        C√≥digo: <b>${l.codigoUnicoERC}</b> ‚Äî Status: <b>${l.statusCliente}</b>
      </p>`).join("");

    if(!html) html="Nenhuma consulta recente.";

    let relatorioDiv=document.getElementById("relatorio");
    if(!relatorioDiv){
      relatorioDiv=document.createElement("div");
      relatorioDiv.id="relatorio"; relatorioDiv.className="card";
      document.querySelector(".wrap").appendChild(relatorioDiv);
    }
    relatorioDiv.innerHTML=`<h3>Consultas dos √∫ltimos 7 dias</h3>${html}`;
  }catch(e){ console.error("Erro ao carregar logs:",e); }
}

carregarRelatorio();
</script>

</body>
</html>
